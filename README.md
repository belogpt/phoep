# Yealink Remote Phonebook Manager

Веб-приложение на Flask для работы с удалённой телефонной книгой Yealink. Позволяет редактировать XML-файл телефонной книги (по умолчанию `rem.xml`) через браузер, импортировать и экспортировать книгу в Excel, управлять группами и путями к файлам. Интерфейс и описания на русском языке. Предназначено для внутреннего сервера (Linux/РЕД ОС) с уже настроенным веб-сервером, отдающим каталог `/var/www/html`.

## Архитектура проекта
- **Backend:** Flask (Python 3) + стандартная библиотека `xml.etree.ElementTree` для чтения/записи XML.
- **Frontend:** HTML5/CSS/JavaScript с Bootstrap из CDN.
- **Хранение:** основной файл телефонной книги (по умолчанию `rem.xml`); Excel импорт/экспорт через `pandas`, `openpyxl`, `xlrd`.
- **Безопасность:** простая HTTP Basic Auth (логин/пароль через переменные окружения).

## Структура репозитория
```
app.py                   # точка входа
phonebook/
  __init__.py
  models.py              # модели контактов и групп
  repository.py          # работа с Config.cfg и XML
  excel_io.py            # логика Excel импорта/экспорта
  routes.py              # Flask-маршруты
templates/
  base.html, index.html, edit_contact.html, manage_groups.html,
  settings.html, import_result.html
static/
  styles.css, main.js
Config.cfg               # пример конфигурации
Dockerfile
docker-compose.yml
.dockerignore
requirements.txt
```

## Установка без Docker
1. Требуется Python 3.11+ и `pip`.
2. Создайте окружение и установите зависимости:
   ```bash
   python -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```
3. Запуск приложения:
   ```bash
   python app.py
   ```
4. Порт задаётся переменной окружения `APP_PORT` (по умолчанию 5000). Приложение слушает `0.0.0.0`.
5. Basic Auth: переменные `BASIC_AUTH_USERNAME` и `BASIC_AUTH_PASSWORD` (по умолчанию `admin`/`admin`). Для безопасности измените их сразу после запуска.
6. Конфигурация путей:
   - Файл `Config.cfg` в корне проекта.
   - Секция `[OutPutPath]`, ключ `RemotePhoneDir` — каталог, где хранится XML телефонной книги.
   - При первом запуске создаётся `Config.cfg` с
     ```
     RemotePhoneDir=/app/data
     LocalPhoneDir=/app/data
     ```
   - Каталог создаётся автоматически, файл телефонной книги (`rem.xml` по умолчанию) тоже.

## Использование
- Главная страница `/` — список контактов, фильтр по группе, поиск, добавление/редактирование/удаление контактов.
- Управление группами `/groups` — переименование и удаление групп (можно удалять вместе с контактами или запретить).
- Настройки `/settings` — изменение `RemotePhoneDir` (сохранение в `Config.cfg`); файл телефонной книги ищется по имени из переменной окружения `PHONEBOOK_FILENAME` (по умолчанию `rem.xml`).
- Скачивание XML: кнопка «Скачать XML» или прямой URL `http://<server>:5000/RemotePhonebook.xml` (маршрут сохранён для совместимости, имя файла в заголовке соответствует текущему `PHONEBOOK_FILENAME`).

### Импорт/экспорт Excel
- Поддерживаются форматы `.xls` и `.xlsx`.
- Ожидаемые столбцы (без учёта регистра):
  - Department
  - Name
  - Office Number
  - Mobile Number
  - Other Number
  - Head Portrait
- Экспорт формирует файл с этими колонками.
- Импорт: **полностью перезаписывает** текущую телефонную книгу. Пустые строки или строки без имени и номеров пропускаются. Перед загрузкой отображается предупреждение.
- Результаты импорта: количество загруженных контактов или сообщение об ошибке (неверные заголовки, повреждённый файл и т.п.).

### Импорт из таблицы отделов (сырой Excel)
- Для ручных таблиц, где строки отделов выделены цветом, а под ними идут сотрудники с номерами.
- Этапы:
  1. Загрузите файл на странице «Импорт из таблицы отделов».
  2. Приложение выделит отделы и сотрудников, попытается найти внутренний номер (первое число из 3–5 цифр в строке).
  3. Для новых отделов попросит ввести сокращения. Предлагаемые значения формируются автоматически (первые буквы слов или первое слово).
  4. Перед сохранением покажет предпросмотр контактов (ФИО, сокращённый отдел, внутренний номер).
- Импорт формирует те же поля, что и обычный Excel: `Name` = ФИО, `Group/Menu` = сокращённый отдел, `Phone1` = найденный внутренний номер.
- Сокращения отделов сохраняются в `departments_aliases.json` в каталоге данных (`RemotePhoneDir`) и используются при следующих загрузках. Пример файла:
  ```json
  {
    "Отдел информационных технологий": "ИТ",
    "Бухгалтерия и финансы": "Бух"
  }
  ```

### Картинки контактов
- Загрузка и управление через веб-интерфейс (форма контакта и раздел «Картинки»).
- Файлы хранятся в каталоге `/app/static/photos` внутри контейнера; на хосте путь задаётся volume (по умолчанию `./static/photos`).
- При загрузке изображение автоматически приводится к PNG и размеру до `100x100` с сохранением пропорций.
- Значение `default_photo` формируется из выбранного источника:
  - встроенные иконки Yealink: `Resource:icon_family_*.png` (список доступен в форме);
  - пользовательские файлы: `/static/photos/<имя_файла>.png` (относительный путь, пригодный для раздачи веб-сервером);
  - при необходимости формат можно изменить в функции `make_default_photo_value`.
- Картинку можно удалить на странице `/photos`, если она не используется ни одним контактом.

### Ограничения и валидация
- До 50 групп.
- Имя группы/контакта — до 99 символов.
- Номера — до 32 символов.
- Если группа пустая при сохранении контакта — запись не создаётся.
- После удаления контакта пустые группы удаляются (поведение включено по умолчанию в коде).

## Развёртывание в Docker (Linux/РЕД ОС)
### Схема хранения
- Телефонная книга должна лежать в каталоге веб-сервера хоста (например, `/var/www/html`).
- По умолчанию Docker Compose монтирует `/var/www/html` на хосте в `/app/data` внутри контейнера.
- Каталог с пользовательскими фото монтируется в `/app/static/photos` (по умолчанию `./static/photos` рядом с проектом). Его тоже можно изменить в `docker-compose.yml`.
- Внутри контейнера файл создаётся как `/app/data/rem.xml`, а на хосте — как `/var/www/html/rem.xml` (или с другим именем, если задано `PHONEBOOK_FILENAME`).
- Если веб-каталог другой, замените путь `/var/www/html` в `docker-compose.yml` на нужный.

### Установка из репозитория
1. Установите `git`, `docker` и при необходимости `docker-compose`.
2. Клонируйте репозиторий и перейдите в каталог проекта:
   ```bash
   git clone https://github.com/<your-org>/phoep.git
   cd phoep
   ```
3. Убедитесь, что веб-сервер отдаёт каталог `/var/www/html` (или свой путь), и там доступно имя файла телефонной книги.
4. Соберите образ и запустите контейнер (Python уже входит в образ `python:3.11-slim`, ставить его на хосте не нужно):
   ```bash
   docker build -t yealink-phonebook .
   docker run -d --name yealink-phonebook -p 5000:5000 \
     -v /var/www/html:/app/data \
     -e PHONEBOOK_FILENAME=rem.xml \
     yealink-phonebook
   ```
   - Переменные окружения можно передать флагами `-e BASIC_AUTH_USERNAME=admin -e BASIC_AUTH_PASSWORD=admin123 -e APP_PORT=5000`.

### Быстрый старт одной командой
1. Сборка образа:
   ```bash
   docker build -t yealink-phonebook .
   ```
2. Запуск одной командой (можно копировать как есть, путь `/var/www/html` измените при необходимости):
   ```bash
   docker build -t yealink-phonebook . && \
   docker run -d --name yealink-phonebook -p 5000:5000 \
     -v /var/www/html:/app/data \
     yealink-phonebook
   ```
   - `/var/www/html` — каталог веб-сервера хоста; внутри него появится `rem.xml`.
   - Контейнер слушает порт 5000.
   - Переменные окружения можно передать флагами `-e BASIC_AUTH_USERNAME=admin -e BASIC_AUTH_PASSWORD=admin123 -e APP_PORT=5000`.
3. Docker Compose:
   ```bash
   docker-compose up -d
   ```
   `docker-compose.yml` монтирует `/var/www/html` в `/app/data` и пробрасывает порт `5000:5000`. Путь можно поменять в файле compose, если веб-каталог отличается.

   Чтобы сразу передать новый пароль администратора при пересборке, задайте переменные окружения перед командой (формат подходит для `docker compose up -d --build`):
   ```bash
   BASIC_AUTH_USERNAME=admin BASIC_AUTH_PASSWORD=<новый_пароль> docker compose up -d --build
   ```
   При этом логин и пароль уйдут внутрь контейнера как переменные, значение по умолчанию `admin/admin` будет перезаписано.

## Работа с Yealink
- В настройках телефона Yealink: Directory → Remote Phone Book.
- URL телефонной книги со стороны телефонов: `http://<ip_сервера>/rem.xml` (веб-сервер отдаёт файл из каталога `/var/www/html`).
- Если задано другое имя файла через `PHONEBOOK_FILENAME` (например `RemotePhonebook.xml`), URL должен совпадать: `http://<ip_сервера>/RemotePhonebook.xml`.
- Маршрут Flask `/RemotePhonebook.xml` на порту 5000 оставлен для совместимости и для скачивания из веб-интерфейса.

## Дополнительно
- Все пути обрабатываются кросс-платформенно через `os.path`.
- При отсутствии файла телефонной книги создаётся пустой каркас:
  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <YealinkIPPhoneBook>
  </YealinkIPPhoneBook>
  ```
- При первом старте создаётся `Config.cfg` с путями `/app/data`.
- Имя файла можно переопределить переменной окружения:
  ```bash
  PHONEBOOK_FILENAME=RemotePhonebook.xml
  ```
  Используйте то же имя в веб-сервере (например, `http://<ip>/RemotePhonebook.xml`).
